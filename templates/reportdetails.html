<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ report.title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    {% load static %} <!-- necessary to connect to CSS in django -->
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>


<body>

<script src={% static 'js/jquery-3.7.1.min.js' %}></script>

<!-- jquery -needed for asynchronous calls (update thread comments) -->


<script src={% static 'js/report.js' %}></script>

<!-- url of current report with different paths passed to javascript file -->

<script>
    var submitUrl = '{% url 'submit_comment' report.id%}'
    var subscribeUrl = '{% url 'toggle_subscribe' report.id%}'
</script>


<!-- request id and role of current user -->
{{ request.user.id|json_script:"user_id" }}
{{ request.user.role|json_script:"user_role" }}

<!-- subscription list for manager check -->
{{ subscriptions |json_script:"subscriptions" }}


    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'main' %}">Home</a>
            {% if user.is_authenticated and user.role == 'agent' %}
                <a class="navbar-brand" href="{% url 'agent_tasks' %}">Tasks</a>
            {% elif user.is_authenticated and user.role == 'manager' %}
                <a class="navbar-brand" href="{% url 'manager_tasks' %}">Tasks</a>
            {% endif %}
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                    <a class="btn btn-blue d-flex align-items-center me-3 py-2 px-4" type="button" href="{% url 'report' %}">
                        <i class="fas fa-plus me-2"></i> New Report
                    </a>
                    </li>
                    <li class="nav-item">
                        {% if not user.is_authenticated %}
                        <a class="nav-link" href="{% url 'login' %}">Login</a>
                        {% endif %}
                    </li>

                    <li class="nav-item">
                        {% if not user.is_authenticated %}
                        <a class="nav-link" href="{% url 'register' %}">Register</a>
                        {% endif %}
                    </li>
                    {% if user.is_authenticated %}
                    <li class="nav-item">
                        <form method="post" action="{% url 'logout' %}">
                        {% csrf_token %}
                        <button class="btn-logout" type="submit">logout</button>
                        </form>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>
    <div class="blue-line"></div>






<div class="button-container" id="button-container">
    <button id="detailsbutton" class="active" onclick="toggleTabs('details')">Details</button>
    <button id="commentsbutton" onclick="toggleTabs('comments')">Comments</button>
    <button id="tasksbutton" onclick="toggleTabs('tasks')">Tasks</button>
</div>

<div class="report-container" id="report-container">
<!-- Tab for report details -->
<div id="details" class="details" style="display: block">

    <div class="row">
        <div class="col-md-8">


    <h1>{{ report.title }}</h1>
    <p><strong>Description:</strong> {{ report.description }}</p>
    <div id="location">
    <p><strong>Location:</strong> [<strong id="longitude">{{ report.lon }}</strong>, <strong id="latitude">{{ report.lat }}</strong>]</p>
    </div>
    <p><strong>Date:</strong> {{ report.date }}</p>
    {% if report.picture.url is not 0 %}
    <img
            class="report-image"
            src="{{ report.picture.url }}"
            alt="{{ report.picture_description }}"
    />
    {% endif %}
    <a href="{% url 'main' %}" class="btn btn-secondary">Back to Map</a>




        {% if user.role in priority and not user.id in subscriptions and not report.user_id is user.id or user.id and user.id not in subscriptions and not report.user_id is user.id %}
        <button id="subscribe" onclick="toggleSubscribe()">Subscribe</button>
        <button id="unsubscribe" style="display: none" onclick="toggleSubscribe()">Unsubscribe</button>
        {% elif user.id in subscriptions and not report.user_id is user.id %}
        <button id="unsubscribe" onclick="toggleSubscribe()">Unsubscribe</button>
        <button id="subscribe" style="display: none" onclick="toggleSubscribe()">Subscribe</button>
        {% endif %}

        </div>
        <div class="col-md-4">


<!-- if condition for peer review functionality -->
  {% if not user.id in users and not report.user_id is user.id%}
        <form id="reportvote" class="reportvote" method="post" action="{% url 'process-vote-entry' report.id%}">
            {% csrf_token %}
            <select id="severityselect" name="severityselect" hidden="hidden">
                    <option selected>-- Select Severity -- </option>
                    <option value="1">Low Level</option>
                    <option value="2">Moderate Level</option>
                    <option value="3">Medium Level</option>
                    <option value="4">High Level</option>
                    <option value="4">Critical Level</option>
            </select>
            <label id="checklabel" class="checkbox"><input type="hidden" id="invcheck" name="invcheck" value="False"></label>
            <p></p>
            <button id="vsubmit" hidden="hidden">Submit Review</button>
        </form>
    {% elif user.id in users %}
        <p>Severity score previously issued: <strong>{{ current_severity }}</strong></p>
        <p>Marked as inappropriate: <strong>{{ flag }}</strong></p>
        <form id="reportedit" method="post" action="{% url 'edit_vote' report.id%}">
            {% csrf_token %}
            <select id="severityselect" name="severityselect" hidden="hidden">
                    <option selected>-- Select Severity -- </option>
                    <option value="1">Low Level</option>
                    <option value="2">Moderate Level</option>
                    <option value="3">Medium Level</option>
                    <option value="4">High Level</option>
                    <option value="4">Critical Level</option>
            </select>
            <label id="checklabel" class="checkbox"><input type="hidden" id="invcheck" name="invcheck" value="False"></label>
            <p></p>
            <button id="vsubmit" hidden="hidden">Confirm Changes</button>
        </form>

    {% endif %}
        <p></p>
        {% if user.role in priority %}
        <button id="showstats" onclick="showVotestats()">Show rating statistics</button>
        <div id="votestats" class="votestats" style="display: none">
        Number of Reviews:<strong> {{ votestats.num_ratings }}</strong>
        <br>Total severity rating:<strong> {{ votestats.total_rating }}</strong></br>
        Flagged by <strong>{{ votestats.flag_count }}</strong> Users
        </div>
        {% endif %}

    </div>

</div>
</div>



<!-- Tab for report comments -->
<div id="comments" class="comments" style="display: none">
    {% if user.id in subscriptions or user.role in priority %}

    <!-- option for creating a comment-->
    <form id="submitcomment" method="post">
        {% csrf_token %}
        <label for="textcomment" class="form-label"></label>
        <textarea id="textcomment" name="textcomment" rows="4" cols="50" placeholder="Enter your Comment"></textarea>
        <br>
        <input type="submit" name="submit" value="submit">
    </form>
    <!-- hidden input with number of comments as value -->
    <input id="ccount" name="ccount" value="{{ comments | length }}" hidden="hidden">


    {% if not comments %}
        <p id="comment-error">No comments yet</p>
    {% else %}
    <!-- Display comments with header -->
    {% for comment in comments %}
    <div class="comment">
    <div class="comment-header">
        <span class="font-weight-bold">{{ comment.username }}</span> &middot;
 		<span class="text-muted">{{ comment.date }}</span>
    </div>
    <div class="comment-body">
        {{ comment.comment | safe }}
    </div>
    </div>
        <br>
    {% endfor %}
    {% endif %}
    {% elif not user.id %}
    <p>Please log in to write a comment</p>
    {% elif user.id not in subscriptions %}
    <p>Please subscribe to view comments</p>
    {% endif %}


</div>
<!-- Tab for Task Creation -->
<div id="tasks" class="tasks" style="display: none;">
    <div class="container mt-5">
    {% if user.id and user.role == "manager" %}
        <h2>Create Task for this Report</h2>
        <form method="post" action="{% url 'create_task' report.id %}">
            {% csrf_token %}

            <!-- Task Description -->
            <div class="mb-3">
                <label for="task_description" class="form-label">Task Description</label>
                <input type="text" class="form-control" id="task_description" name="description" placeholder="Enter task description" required>
            </div>

            <!-- Task Due Date -->
            <div class="mb-3">
                <label for="task_due_date" class="form-label">Due Date</label>
                <input type="date" class="form-control" id="task_due_date" name="due_date" required>
            </div>

            <!-- Assign Agent -->
            <div class="mb-3">
                <label for="task_agent" class="form-label">Assign Agent</label>
                <select name="agent" id="task_agent" class="form-select">
                    <option value="" disabled selected>Select an agent</option>
                    {% for agent in available_agents %}
                        <option value="{{ agent.id }}">{{ agent.first_name }} {{ agent.last_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary">Create Task</button>
        </form>
        {% elif not user.id %}
        <p>Only agents and managers are able to see tasks</p>    
        {% endif %}
    </div>
</div>
</div>



</body>
</html>


